name: Development Branch Workflow
 
on: 
  push:
    branches: [ development ]
  pull_request:
    branches: [ development ] 
 
 
jobs:
  # This step will build the maven application
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with: 
        java-version: 1.8
    - name: Cache Maven packages
      uses: actions/cache@v2
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    - name: Build with Maven
      run: mvn clean package
          
    - uses: actions/upload-artifact@v1
      with:
        name: verademo.war
        path: target/verademo.war

  pipeline_scan:
     # needs the build step before this job will start running
     needs: build
     runs-on: ubuntu-latest
     name: pipeline scan

     steps:
       - name: checkout repo
         uses: actions/checkout@v3
      
      # get the compiled binary from a previous job
       - name: get archive
         uses: actions/download-artifact@v3
         with:
           name: verademo.war
           path: /tmp

      # run the pipeline scan action
       - name: pipeline-scan action step
         id: pipeline-scan
         uses: veracode/Veracode-pipeline-scan-action@v1.0.10
         with:
           vid: ${{ secrets.VERACODE_API_ID }}
           vkey: ${{ secrets.VERACODE_API_KEY }}
           file: "/tmp/verademo.war" 
           veracode_policy_name: "HIPAA Policy"
           fail_build: true
          
  # Create issues from piepline scan
  import_flaws_job:
     runs-on: ubuntu-latest
     needs:  pipeline_scan
     name: import flaws

     steps:
       - name: get pipeline-scan results
         uses: actions/download-artifact@v2
         with:
          name: filtered-results

       - name: import flaws as issues
         uses: buzzcode/veracode-flaws-to-issues@v1
         with:
           scan-results-json: 'filtered_results.json'
           github-token: ${{ secrets.GH_TOKEN }}
           source-base-path_1: "com/veracode:src/main/java/com/veracode" 
           source-base-path_2: "WEB-INF:src/main/webapp/WEB-INF"
           commit-hash: ${{ GITHUB.SHA }}

        
  # Run a Software Composition Analysis scan
  software-composition-analysis:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with: 
        java-version: 1.8
    - name: Cache Maven packages
      uses: actions/cache@v2
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    - run: curl -sSL https://download.sourceclear.com/ci.sh | bash -s scan . --update-advisor 2>&1 | tee sca_output.txt
      env:
        SRCCLR_API_TOKEN: ${{secrets.SRCCLR_API_TOKEN}}
    - uses: actions/upload-artifact@v1
      with:
        name: SCAScanResults
        path: sca_output.txt
